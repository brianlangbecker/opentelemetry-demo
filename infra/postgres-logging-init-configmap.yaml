apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-logging-init
  namespace: otel-demo
data:
  init-logging.sh: |
    #!/bin/sh
    # PostgreSQL Logging Configuration Init Script
    # This script runs as an init container before PostgreSQL starts
    # It creates postgresql.auto.conf with logging settings

    set -e

    PGDATA="/var/lib/postgresql/data"
    AUTO_CONF="${PGDATA}/postgresql.auto.conf"

    echo "============================================"
    echo "PostgreSQL Logging Configuration Init"
    echo "============================================"

    # Check if PGDATA exists (it should be created by postgres initdb)
    if [ ! -d "${PGDATA}" ]; then
        echo "INFO: ${PGDATA} does not exist, will be created by PostgreSQL"
        mkdir -p "${PGDATA}"
    fi

    # Append to postgresql.auto.conf with logging settings
    # Use a marker to avoid duplicate entries on restarts
    MARKER="# OpenTelemetry Logging Config"

    if grep -q "${MARKER}" "${AUTO_CONF}" 2>/dev/null; then
        echo "INFO: Logging configuration already present in ${AUTO_CONF}"
        exit 0
    fi

    echo "Configuring PostgreSQL logging in ${AUTO_CONF}..."

    cat >> "${AUTO_CONF}" << 'EOFCONF'

    # OpenTelemetry Logging Config
    # Auto-generated by init container for OpenTelemetry log collection
    # These settings enable comprehensive logging for observability

    # Enable logging to file (required for OTel collector to read logs)
    logging_collector = on
    log_destination = 'stderr,csvlog'
    log_directory = '/var/log/postgresql'
    log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
    log_file_mode = 0644
    log_rotation_age = 1d
    log_rotation_size = 100MB
    log_truncate_on_rotation = off

    # Lock and concurrency logging (KEY for table lock detection)
    log_lock_waits = on
    deadlock_timeout = 1s

    # Performance logging
    log_min_duration_statement = 1000
    log_duration = off
    log_statement = 'none'

    # Enhanced log format
    log_line_prefix = '%t [%p] %u@%d '
    log_timezone = 'UTC'

    # Connection logging
    log_connections = on
    log_disconnections = on

    # Checkpoint logging (for performance analysis)
    log_checkpoints = on

    # Error logging
    log_error_verbosity = default
    EOFCONF

    echo "âœ“ Appended logging configuration to ${AUTO_CONF}"

    # File already has correct permissions from PostgreSQL's init
    # No need to chmod/chown
    echo "============================================"
    echo "PostgreSQL logging configuration complete"
    echo "PostgreSQL will read these settings on startup"
    echo "============================================"

    echo "Configuration contents:"
    cat "${AUTO_CONF}"
